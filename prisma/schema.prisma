generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum InfractionType {
  Warn
  Mute
  Kick
  Ban
  Unmute
  Unban
}

enum TaskType {
  Mute
  Ban
}

enum InfractionFlag {
  Automatic
  Native
  Quick
}

enum ReportStatus {
  Pending
  Disregarded
  Accepted
  Denied
}

enum RequestStatus {
  Pending
  Accepted
  Denied
}

enum PermissionEnum {
  SearchInfractions
  ManageMessageReports
  ManageUserReports
}

model Guild {
  id String @id @map("_id")

  // Command settings

  commandDisabledList      String[]
  commandErrorTTL          Int      @default(7500)
  commandTemporaryReplyTTL Int      @default(5000)
  commandEphemeralReply    Boolean  @default(true)

  // Component settings

  componentErrorTTL          Int @default(5000)
  componentTemporaryReplyTTL Int @default(5000)

  // Report settings

  messageReportsEnabled             Boolean  @default(false)
  messageReportsWebhook             String?
  messageReportsImmuneRoles         String[]
  messageReportsPingRoles           String[]
  messageReportsBlacklist           String[]
  messageReportsRequireMember       Boolean  @default(true)
  messageReportsDisregardAfter      BigInt   @default(2592000000)
  messageReportsNotifyStatus        Boolean  @default(true)
  messageReportsRequireAcceptReason Boolean  @default(false)
  messageReportsRequireDenyReason   Boolean  @default(false)

  userReportsEnabled             Boolean  @default(false)
  userReportsWebhook             String?
  userReportsImmuneRoles         String[]
  userReportsPingRoles           String[]
  userReportsBlacklist           String[]
  userReportsRequireMember       Boolean  @default(true)
  userReportsDisregardAfter      BigInt   @default(2592000000)
  userReportsNotifyStatus        Boolean  @default(true)
  userReportsRequireAcceptReason Boolean  @default(false)
  userReportsRequireDenyReason   Boolean  @default(false)

  reportLoggingEnabled Boolean @default(true)
  reportLoggingWebhook String?

  // Request settings

  banRequestsEnabled     Boolean  @default(false)
  banRequestsWebhook     String?
  banRequestsImmuneRoles String[]
  banRequestsImmuneUsers String[]

  muteRequestsEnabled     Boolean  @default(false)
  muteRequestsWebhook     String?
  muteRequestsImmuneRoles String[]
  muteRequestsImmuneUsers String[]

  // Infraction settings

  requireWarnReason   Boolean @default(true)
  requireMuteReason   Boolean @default(true)
  requireKickReason   Boolean @default(true)
  requireBanReason    Boolean @default(true)
  requireUnmuteReason Boolean @default(false)
  requireUnbanReason  Boolean @default(false)

  notifyWarnAction   Boolean @default(true)
  notifyMuteAction   Boolean @default(true)
  notifyKickAction   Boolean @default(true)
  notifyBanAction    Boolean @default(true)
  notifyUnmuteAction Boolean @default(true)

  defaultWarnDuration BigInt @default(0)
  defaultMuteDuration BigInt @default(0)
  defaultBanDuration  BigInt @default(0)

  nativeModerationIntegration Boolean @default(true)

  infractionLoggingEnabled Boolean @default(true)
  infractionLoggingWebhook String?

  // Message logging settings

  messageLoggingEnabled         Boolean  @default(true)
  messageLoggingWebhook         String?
  messageLoggingIgnoredChannels String[]
  messageLoggingStoreMessages   Boolean  @default(true)

  // Permissions

  permissions Permission[]

  // Ephemeral scopes

  ephemeralScopes EphemeralScope[]

  // Relations

  infractions    Infraction[]
  messageReports MessageReport[]
  userReports    UserReport[]
  banRequests    BanRequest[]
  muteRequests   MuteRequest[]
  messages       Message[]
  tasks          Task[]
}

model Infraction {
  id         String          @id @map("_id")
  guildId    String
  targetId   String
  executorId String
  requestId  String?
  type       InfractionType  @default(Warn)
  reason     String
  createdAt  BigInt
  expiresAt  BigInt?
  flag       InfractionFlag?

  task  Task?
  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model Task {
  id           String   @id @map("_id")
  guildId      String
  targetId     String
  infractionId String   @unique
  type         TaskType
  expiresAt    BigInt

  infraction Infraction? @relation(fields: [infractionId], references: [id], onDelete: Cascade)
  guild      Guild       @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([targetId, guildId, type])
}

model MessageReport {
  // ID of the log
  id         String  @id @map("_id")
  guildId    String
  messageId  String
  messageUrl String
  channelId  String
  authorId   String
  content    String?

  reportedAt   BigInt
  reportedBy   String
  reportReason String

  status ReportStatus @default(Pending)

  resolvedAt BigInt?
  resolvedBy String?

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model UserReport {
  // ID of the log
  id       String @id @map("_id")
  guildId  String
  targetId String

  reportedAt   BigInt
  reportedBy   String
  reportReason String

  status ReportStatus @default(Pending)

  resolvedAt BigInt?
  resolvedBy String?

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model BanRequest {
  // ID of the log
  id       String @id @map("_id")
  guildId  String
  targetId String

  status RequestStatus @default(Pending)

  resolvedAt BigInt?
  resolvedBy String?

  requestedAt BigInt
  requestedBy String

  expiresAt BigInt?
  reason    String

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model MuteRequest {
  // ID of the log
  id       String @id @map("_id")
  guildId  String
  targetId String

  status RequestStatus @default(Pending)

  resolvedAt BigInt?
  resolvedBy String?

  requestedAt BigInt
  requestedBy String

  expiresAt BigInt
  reason    String

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model Message {
  id                    String   @id @map("_id")
  guildId               String
  authorId              String
  channelId             String
  channelParentId       String?
  channelParentParentId String?
  stickerId             String?
  // ID of the message this message is replying to
  referenceId           String?
  createdAt             BigInt
  content               String?
  attachments           String[]
  deleted               Boolean  @default(false)

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

type Permission {
  name  String
  roles String[]
  allow PermissionEnum[]
}

type EphemeralScope {
  commandName      String
  includedChannels String[]
  excludedChannels String[]
}
